name: Run e2e-tests every 2 hours

on:
  repository_dispatch:
    types: [ ok-to-test-command ]
  schedule:
    - cron: '0 */2 * * *'  # every 2h

jobs:
  # Run e2e tests on self-hosted runner
  integration-cron:
    runs-on: self-hosted
    steps:
      - name: Set up Go 1.14
        uses: actions/setup-go@v2
        with:
          go-version: ^1.14
        id: go

      - name: Check out code into the Go module directory
        uses: actions/checkout@v2

      - name: Get dependencies
        run: |
          go get -u golang.org/x/lint/golint
          go get -u golang.org/x/tools/cmd/goimports

      - name: Check sts
        run: |
          aws sts get-caller-identity
          TOKEN=`curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600"` \
          && curl -H "X-aws-ec2-metadata-token: $TOKEN" -v http://169.254.169.254/latest/meta-data/iam/security-credentials/vpc-cni-tester

      - name: Set up AWS credentials for 3h
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-region: us-west-2
          role-to-assume: vpc-cni-tester
          role-duration-seconds: 10800

      - name: Run e2e tests
        env:
          DISABLE_PROMPT: "true"
          RUN_CONFORMANCE: "true"
          TESTER_DIR: "."
          AWS_DEFAULT_REGION: "us-west-2"

        run: |
          ./scripts/run-integration-tests.sh

